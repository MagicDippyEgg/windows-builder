name: Windows Build Workflow
on:
  workflow_call:
    inputs:
      mcpelauncher-ref:
        type: string
        default: 'ng'
      publish:
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout Builder Repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.15.2'
          host: 'windows'
          arch: 'win64_msvc2019_64'
          modules: 'qtwebengine'
          setup-python: 'true'

      - name: Setup MSVC & CMake
        uses: lukka/get-cmake@latest

      - name: Install Dependencies (vcpkg)
        shell: pwsh
        run: |
          vcpkg install openssl:x64-windows
          vcpkg install protobuf:x64-windows
          vcpkg install zlib:x64-windows
          vcpkg install libpng:x64-windows
          vcpkg install angle:x64-windows
          vcpkg install sdl2:x64-windows
          vcpkg install libzip:x64-windows
          vcpkg install pthreads:x64-windows

      - name: Clone and Checkout MCPELauncher
        shell: pwsh
        run: |
          if (Test-Path "source") { Remove-Item -Recurse -Force "source" }
          git clone https://github.com/minecraft-linux/mcpelauncher-manifest source --recursive
          cd source
          git checkout ${{ inputs.mcpelauncher-ref }}
          git submodule update --init --recursive

      - name: Apply Mega Windows Patches
        shell: pwsh
        run: |
          # --- Directories Setup (FIXED: Creating subdirectories explicitly) ---
          $incDir = "source/compat-include"
          $sysDir = "$incDir/sys"
          $arpaDir = "$incDir/arpa"
          $netinetDir = "$incDir/netinet"
          
          New-Item -ItemType Directory -Force -Path $sysDir | Out-Null
          New-Item -ItemType Directory -Force -Path $arpaDir | Out-Null
          New-Item -ItemType Directory -Force -Path $netinetDir | Out-Null
          
          # --- 1. Global Compatibility Definitions ---
          $compatDefs = @"
          #pragma once
          #if defined(_MSC_VER)
            #define __attribute__(x)
            #define _CRT_SECURE_NO_WARNINGS
            #define _WINSOCK_DEPRECATED_NO_WARNINGS
            
            #include <stddef.h>
            #include <string.h>
            #include <stdio.h>
            #include <basetsd.h>
            #include <sys/types.h>
            #include <sys/stat.h>
            #include <io.h>
            #include <direct.h>
            
            typedef SSIZE_T ssize_t;
            
            // Fix missing stat64 and friends
            #define stat64 _stat64
            #define fstat64 _fstat64
            #define lstat64 _stat64
            
            // Fix file IO
            #define ftruncate _chsize
            #define ftruncate64 _chsize_s
            #define lseek64 _lseeki64
            #define fileno _fileno
            #define isatty _isatty
            #define access _access
            #define F_OK 0
            #define X_OK 0 
            #define PATH_MAX 260
            
            // Fix missing S_ macros
            #ifndef S_ISDIR
            #define S_ISDIR(m) (((m) & S_IFMT) == S_IFDIR)
            #endif
            #ifndef S_ISLNK
            #define S_ISLNK(m) 0
            #endif
            
            // Stubs for user/group functions
            #define getuid() (0)
            #define getpwuid_r(uid, pwd, buf, len, res) (NULL)
            #define readlink(path, buf, size) (-1)
            
            // Fix strrchr ambiguity
            #ifdef __cplusplus
            extern "C++" {
                inline char* strrchr_cast(char* s, int c) { return const_cast<char*>(strrchr(s, c)); }
            }
            #define strrchr strrchr_cast
            #endif
          #endif
          "@
          Set-Content -Path "$incDir/compat_defs.h" -Value $compatDefs

          # --- 2. Network & System Headers ---
          
          # poll.h
          $pollH = @"
          #pragma once
          #include <winsock2.h>
          typedef WSAPOLLFD pollfd;
          #define poll(fds, nfds, timeout) WSAPoll(fds, nfds, timeout)
          "@
          Set-Content -Path "$incDir/poll.h" -Value $pollH

          # sys/un.h
          Set-Content -Path "$sysDir/un.h" -Value "#pragma once`n#include <winsock2.h>`nstruct sockaddr_un { short sun_family; char sun_path[108]; };"
          
          # netdb.h
          Set-Content -Path "$incDir/netdb.h" -Value "#pragma once`n#include <winsock2.h>`n#include <ws2tcpip.h>"
          
          # sys/utsname.h
          $utsnameH = @"
          #pragma once
          struct utsname {
            char sysname[65]; char nodename[65]; char release[65];
            char version[65]; char machine[65];
          };
          static int uname(struct utsname* n) { return -1; }
          "@
          Set-Content -Path "$sysDir/utsname.h" -Value $utsnameH

          # unistd.h
          $unistdH = @"
          #pragma once
          #include <io.h>
          #include <process.h>
          #define _SC_ARG_MAX 0
          #define _SC_CLK_TCK 100
          #define _SC_PAGESIZE 4096
          #define _SC_PHYS_PAGES 1
          #define _SC_NPROCESSORS_ONLN 1
          #define _SC_GETPW_R_SIZE_MAX 1024
          "@
          Set-Content -Path "$incDir/unistd.h" -Value $unistdH

          # dirent.h
          $direntH = @"
          #pragma once
          #include <windows.h>
          #include <stdio.h>
          struct dirent { char d_name[260]; int d_type; };
          typedef struct DIR DIR;
          #define DT_DIR 4
          #define DT_REG 8
          struct DIR { HANDLE hFind; WIN32_FIND_DATA data; struct dirent ent; int first; };
          static DIR* opendir(const char* dir) {
              char path[260]; snprintf(path, sizeof(path), "%s\\*", dir);
              DIR* d = (DIR*)calloc(1, sizeof(DIR));
              d->hFind = FindFirstFileA(path, &d->data);
              if (d->hFind == INVALID_HANDLE_VALUE) { free(d); return NULL; }
              d->first = 1;
              return d;
          }
          static struct dirent* readdir(DIR* d) {
              if (!d->first) { if (!FindNextFileA(d->hFind, &d->data)) return NULL; }
              d->first = 0;
              snprintf(d->ent.d_name, sizeof(d->ent.d_name), "%s", d->data.cFileName);
              d->ent.d_type = (d->data.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY) ? DT_DIR : DT_REG;
              return &d->ent;
          }
          static int closedir(DIR* d) { FindClose(d->hFind); free(d); return 0; }
          "@
          Set-Content -Path "$incDir/dirent.h" -Value $direntH

          # libgen.h
          Set-Content -Path "$incDir/libgen.h" -Value "#pragma once`nstatic char* basename(char* p) { return p; }`nstatic char* dirname(char* p) { return p; }"

          # --- 3. Missing System Headers (Stubs) ---
          Set-Content -Path "$sysDir/time.h" -Value "#pragma once`n#include <time.h>`nstruct timezone { int tz_minuteswest; int tz_dsttime; };"
          Set-Content -Path "$sysDir/wait.h" -Value "#pragma once`n#define WEXITSTATUS(s) ((s) & 0xff00) >> 8`n#define WIFEXITED(s) 1"
          Set-Content -Path "$sysDir/mman.h" -Value "#pragma once`n#define PROT_READ 1`n#define PROT_WRITE 2`n#define MAP_PRIVATE 2`n#define MAP_FAILED ((void*)-1)`nstatic void* mmap(void* a, size_t l, int p, int f, int d, long long o) { return MAP_FAILED; }`nstatic int munmap(void* a, size_t l) { return -1; }"
          Set-Content -Path "$sysDir/ioctl.h" -Value "#pragma once"
          Set-Content -Path "$sysDir/resource.h" -Value "#pragma once"
          Set-Content -Path "$incDir/semaphore.h" -Value "#pragma once"
          
          # arpa/inet.h (Fixed: Directory creation added above)
          Set-Content -Path "$arpaDir/inet.h" -Value "#pragma once`n#include <winsock2.h>"
          
          # netinet/tcp.h (Proactive Fix)
          Set-Content -Path "$netinetDir/tcp.h" -Value "#pragma once`n#include <winsock2.h>"

          # --- 4. Source Patches ---
          # Eglut
          $eglutCMake = "source/eglut/CMakeLists.txt"
          if (Test-Path $eglutCMake) {
             $content = Get-Content $eglutCMake
             $newContent = $content | Where-Object { $_ -notmatch "_x11.c" -and $_ -notmatch "xinput.c" }
             $newContent | Set-Content $eglutCMake
          }

          # Logger
          $logFile = "source/logger/src/log.cpp"
          if (Test-Path $logFile) {
             $c = Get-Content $logFile -Raw
             $fix = "#if defined(_WIN32)`n#include <time.h>`ninline struct tm* localtime_r(const time_t* t, struct tm* r) { localtime_s(r, t); return r; }`n#endif`n"
             Set-Content -Path $logFile -Value ($fix + $c)
          }

          # Linker Stub
          $linkerCMake = "source/mcpelauncher-linker/CMakeLists.txt"
          $stubContent = @"
          cmake_minimum_required(VERSION 3.10)
          project(mcpelauncher-linker)
          file(WRITE "`{CMAKE_CURRENT_BINARY_DIR}/dummy_linker.cpp" "void linker_stub() {}")
          add_library(mcpelauncher-linker STATIC "`{CMAKE_CURRENT_BINARY_DIR}/dummy_linker.cpp")
          add_library(mcpelauncher-linker-core STATIC "`{CMAKE_CURRENT_BINARY_DIR}/dummy_linker.cpp")
          target_include_directories(mcpelauncher-linker PUBLIC include)
          target_include_directories(mcpelauncher-linker-core PUBLIC core/include)
          "@
          Set-Content -Path $linkerCMake -Value $stubContent

          if (Test-Path "source/linux-gamepad/CMakeLists.txt") {
              Set-Content -Path "source/linux-gamepad/CMakeLists.txt" -Value "# Stubbed"
          }

          # --- 5. Robust CMake Syntax Patching ---
          $cmakeFiles = Get-ChildItem -Path "source" -Recurse -Filter "CMakeLists.txt"
          foreach ($file in $cmakeFiles) {
              $content = [System.IO.File]::ReadAllText($file.FullName)
              # FIXED: Changed 's*' to '\s*' to correctly match whitespace instead of the letter 's'
              $pattern = '(?s)cmake_minimum_required\s*[(].*?[)]'
              $replacement = 'cmake_minimum_required(VERSION 3.10)'
              
              if ($content -match 'cmake_minimum_required') {
                  $content = [System.Text.RegularExpressions.Regex]::Replace(
                      $content, 
                      $pattern, 
                      $replacement, 
                      [System.Text.RegularExpressions.RegexOptions]::IgnoreCase
                  )
              } else {
                  $content = "$replacement`n" + $content
              }
              
              $content = $content.Replace('-fno-delete-null-pointer-checks', '')
              [System.IO.File]::WriteAllText($file.FullName, $content, [System.Text.Encoding]::UTF8)
          }

      - name: Configure CMake
        shell: pwsh
        run: |
          if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
          mkdir build
          
          # Added /EHsc for exception handling
          cmake -S source -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_SDL_INPUT=ON `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" `
            "-DCMAKE_PREFIX_PATH=$env:Qt5_Dir" `
            "-DCMAKE_CXX_FLAGS=/EHsc /I $PWD/source/compat-include /FI $PWD/source/compat-include/compat_defs.h"

      - name: Build Project
        run: cmake --build build --config Release -j 4

      - name: Package Artifacts (windeployqt)
        shell: pwsh
        run: |
          mkdir dist
          Get-ChildItem -Path build/Release -Include *.exe, *.dll -Recurse | Copy-Item -Destination dist/
          $exe = (Get-ChildItem dist/*.exe | Select-Object -First 1).FullName
          if ($exe) {
             & "$env:Qt5_Dir/bin/windeployqt.exe" $exe --no-translations --no-system-d3d-compiler --compiler-runtime --dir dist
          }

      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: mcpelauncher-windows-x64
          path: dist/